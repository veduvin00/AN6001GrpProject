<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dummy Bank | Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">
      <img src="/static/images/bank_logo.png" alt="" width="40" height="40">
      Dummy Bank
    </span>
    <div class="d-flex align-items-center">
      <span class="text-white me-3">Hi, {{ username }}</span>
      <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-4">

  <!-- TABS -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#assistant">
        üí¨ Assistant
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#transactions">
        ‚ûï Add Transaction
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics">
        üìä Analytics
      </button>
    </li>
  </ul>

  <!-- ================= TWO COLUMN LAYOUT ================= -->
  <div class="row mt-4">

    <!-- ================= LEFT: MAIN CONTENT ================= -->
    <div class="col-md-8">
      <div class="tab-content">

        <!-- ASSISTANT TAB -->
        <div class="tab-pane fade show active" id="assistant">
          <div class="card p-4 shadow">
            <h5>Welcome üëã</h5>
            <p>
              Use the assistant on the right to ask questions about your finances,
              transactions, or analytics.
            </p>
          </div>
        </div>

        <!-- ADD TRANSACTION TAB -->
        <div class="tab-pane fade" id="transactions">
          <div class="card shadow p-4 col-md-8 mx-auto">
            <h5 class="mb-3">Add Transaction</h5>

            <form id="transactionForm">
              <input class="form-control mb-2" type="date" name="date" required>

              <input class="form-control mb-2" type="number" step="0.01"
                     name="amount" placeholder="Amount" required>

              <select class="form-control mb-2" name="category" required>
                <option value="" disabled selected>Select category</option>
                <option>Dining</option>
                <option>Shopping</option>
                <option>Rent</option>
                <option>Transport</option>
                <option>Other</option>
              </select>

              <input class="form-control mb-3"
                     name="merchant" placeholder="Merchant">

              <button class="btn btn-primary w-100" type="submit">
                Add Transaction
              </button>
            </form>

            <div id="txnSuccess" class="alert alert-success mt-3 d-none">
              ‚úÖ Transaction added successfully
            </div>
          </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div class="tab-pane fade" id="analytics">

          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card shadow p-3">
                <h6>Spending by Category</h6>
                <canvas id="categoryChart"></canvas>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card shadow p-3">
                <h6>Monthly Spending Trend</h6>
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>

          <div class="card shadow p-3 mt-4">
            <h6>What-If Analysis</h6>

            <select id="whatIfCategory" class="form-control mb-2">
              <option>Dining</option>
              <option>Shopping</option>
              <option>Rent</option>
              <option>Transport</option>
            </select>

            <input id="whatIfDelta"
                   type="number"
                   class="form-control mb-2"
                   placeholder="Change amount (e.g. -50)">

            <button class="btn btn-primary" onclick="runWhatIf()">Simulate</button>
            <div id="whatIfResult" class="mt-3"></div>
          </div>

          <div class="card shadow p-3 mt-4">
            <h6>Transaction History</h6>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Merchant</th>
                    <th class="text-end">Amount</th>
                  </tr>
                </thead>
                <tbody id="transactionsTableBody"></tbody>
              </table>
            </div>
          </div>

        </div>

      </div>
    </div>

    <!-- ================= RIGHT: CHAT ================= -->
    <div class="col-md-4">
      <div class="chat-container shadow">
        <div class="chat-header">
          <img src="/static/images/bot.png" class="bot-avatar">
          <div>
            <div class="fw-bold">Bank Assistant</div>
            <small class="text-success">‚óè Online</small>
          </div>
        </div>

        <div class="chat-body" id="messages">
          <div class="bot-message">
            Hi üëã I‚Äôm your financial assistant.
            Ask me about what you see on the screen.
          </div>
        </div>

        <div id="typing" class="typing-indicator d-none">
          <span></span><span></span><span></span>
        </div>

        <div class="chat-input">
          <input id="userInput"
                 placeholder="Ask about your finances‚Ä¶"
                 onkeydown="handleEnter(event)">
          <button onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="/static/chatbot.js"></script>
<script src="/static/analytics.js"></script>

<!-- üî• ADD TRANSACTION HANDLER (KEY FIX) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("transactionForm");
  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const successMsg = document.getElementById("txnSuccess");
    successMsg.classList.add("d-none");

    try {
      const res = await fetch("/add-transaction", {
        method: "POST",
        body: new FormData(form)
      });

      if (!res.ok) throw new Error("Add transaction failed");

      form.reset();
      successMsg.classList.remove("d-none");

      // üî• Refresh analytics immediately
      if (typeof loadTransactionsTable === "function") {
        loadTransactionsTable();
      }
      if (typeof loadCategoryChart === "function") {
        loadCategoryChart();
      }
      if (typeof loadMonthlyChart === "function") {
        loadMonthlyChart();
      }

    } catch (err) {
      console.error(err);
      alert("Error adding transaction. Please try again.");
    }
  });
});
</script>

</body>
</html>
